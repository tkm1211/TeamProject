#include <FrameWork.h>
#include <string>

#include "SceneGame.h"
#include "InputDevice.h"
#include "SoundLoader.h"
#include "CameraSystem.h"
#include "SceneTitle.h"
#include "GameSystem.h"
// 追加
#include "EnemyManager.h"
#include "EnemyDerived01.h"


void SceneGame::Init()
{
	//testModel = std::make_unique<Model>("Data/Assets/Model/player_anime.fbx", false);
	//{
	//	testModel->StartAnimation(2, true);
	//	testModelData.Init();
	//	testModelData.SetScale(DirectX::XMFLOAT3(0.01f, 0.01f, 0.01f));
	//}


		// モデルの初期化
	testModel = std::make_unique<Model>("Data/Assets/Model/Player/EX/bullet_box_pi.fbx", false);
	{
		//testModel->StartAnimation(1, true); // 引数 : FBX内のアニメーション番号, ループ再生するか？
		testModelData.Init();
	}





	// すべてのサウンドを停止
	{
		AllSoundStop();
		AllBgmSoundStop();
	}

	// サウンドの再生
	{
		PlaySoundMem(SoundLoader::GetInstance()->bgm.get()); // ループ再生
		PlaySoundMem(SoundLoader::GetInstance()->se.get()); // 単発再生
	}

	GameSystem::Instance().Init();

	EnemyManager::Instance().Init();

	std::shared_ptr<Enemy> enemy_00 = std::make_shared<EnemyDerrived01>();
	EnemyManager::Instance().Spawn(enemy_00);
}


void SceneGame::Update()
{
	if (Fade::GetInstance()->loading) return;

	// シーン遷移
	//if (GetAsyncKeyState(VK_SPACE) < 0/*xInput[0].bAt || xInput[0].bBt || xInput[0].bXt || xInput[0].bYt*/)
	//{
	//	Fade::GetInstance()->onFadeFlg = true;
	//	Fade::GetInstance()->loading = true;
	//	Fade::GetInstance()->SetNextScene(new SceneTitle());
	//}




	EnemyManager::Instance().Update();

	// 更新
	GameSystem::Instance().Update();
}


void SceneGame::Render()
{
	EnemyManager::Instance().Render();

	// モデルの描画
	{
		testModel->Preparation(ShaderSystem::GetInstance()->GetShaderOfSkinnedMesh(ShaderSystem::DEFAULT), true);
		testModel->Render(testModelData.GetWorldMatrix(), CameraSystem::GetInstance()->mainView.GetViewMatrix(), CameraSystem::GetInstance()->mainView.GetProjectionMatrix(),
			DirectX::XMFLOAT4(0.0f, -1.0f, 1.0f, 0.0f), testModelData.GetColor(), FrameWork::GetInstance().GetElapsedTime());
	}


}


void SceneGame::ImGui()
{
	ImGui::Text("Scene : Game");
	GameSystem::Instance().ImGui();
}


void SceneGame::UnInit()
{
	GameSystem::Instance().UnInit();
	testModelData.UnInit();
}